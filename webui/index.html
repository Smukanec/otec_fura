<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Jarvik ‚Äì Fura</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000000;
      --panel: #000000;
      --text: #00ff00;
      --muted: #00ff00;
      --accent: #00ff00;
      --accent-2: #00ff00;
      --danger: #00ff00;
      --border: #00ff00;
      --shadow: rgba(0,0,0,0.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: var(--sans); line-height: 1.42;
    }
    header {
      position: sticky; top: 0; z-index: 5;
      display: flex; align-items: center; gap: .8rem;
      padding: .8rem 1rem; background: var(--bg);
      border-bottom: 1px solid var(--border); box-shadow: 0 6px 20px var(--shadow);
    }
    #logo { height: 28px; width: 28px; filter: drop-shadow(0 0 6px rgba(0,255,0,.5)); }
    #logo.spin { animation: spin 1.2s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

    h1 { font-size: 16px; font-weight: 600; margin: 0; letter-spacing: .5px; }
    main.grid {
      display: grid; gap: 12px; padding: 12px;
      grid-template-columns: minmax(260px, 320px) 1fr minmax(260px, 320px);
    }
    .col { display: flex; flex-direction: column; gap: 8px; }
    .panel {
      background: var(--panel); border: 1px solid var(--border); border-radius: 10px;
      padding: 12px; box-shadow: 0 10px 30px var(--shadow);
    }
    label { display:block; font-size: 12px; color: var(--muted); margin: 6px 0 4px; }
    .row { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
    .sep { height: 8px; }
    input[type="password"], input[type="text"], select, textarea {
      width: 100%; box-sizing: border-box; background: var(--bg); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; outline: none;
    }
    textarea { min-height: 100px; resize: vertical; font-family: var(--sans); }
    .btn {
      background: var(--bg); color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px;
      font-weight: 600; cursor: pointer; box-shadow: 0 6px 16px rgba(0,255,0,.25);
    }
    .btn:hover { filter: brightness(1.06); }
    .ghost { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    .small { font-size: 12px; color: var(--muted); }
    .hidden { display: none !important; }
    pre.block {
      background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:8px; overflow:auto; max-height:40vh;
      font-family: var(--mono); white-space: pre-wrap;
    }

    /* ===== Chat layout: scrollovac√≠ zpr√°vy ===== */
    #chat {
      display: grid;
      grid-template-rows: 1fr auto;   /* zpr√°vy vypln√≠ dostupnou v√Ω≈°ku, editor je dole */
      gap: 10px;
      min-height: 60vh;
      max-height: 75vh;               /* aby se panel neroztahoval donekoneƒçna */
    }
    #messages {
      display:flex; flex-direction:column; gap:10px;
      overflow-y: auto;               /* kl√≠ƒçov√©: rolujeme */
      padding-right: 4px;
      border: 1px solid var(--border);
      border-radius: 10px;
    }

    /* ===== Bubliny + oznaƒçen√≠ role ===== */
    .msg {
      padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      position: relative;
    }
    .msg::before {
      content: attr(data-role);
      position: absolute; top: -9px; left: 10px;
      font-size: 11px; padding: 0 6px;
      background: var(--bg);
      color: var(--muted);
    }
    .user { border-left: 3px solid var(--accent); }
    .ai   { border-left: 3px solid var(--accent-2); }
    .system { border-left: 3px solid var(--danger); opacity: .9; }

    option.uncensored { color: var(--danger); font-weight: 600; }
    .tip { color: var(--muted); font-size: 12px; margin-top: 4px; }
    @media (max-width: 980px) {
      main.grid { grid-template-columns: 1fr; }
      #chat { max-height: unset; } /* na mobilu nech√°me p≈ôirozenou v√Ω≈°ku */
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Jarvik logo" id="logo">
    <h1>Jarvik ‚Äì Fura</h1>
  </header>

  <main class="grid">
    <!-- lev√Ω panel -->
    <section class="col panel" aria-label="Ovl√°d√°n√≠">
      <div id="apikeyRow" class="row">
        <label style="min-width:70px">API Key</label>
        <input id="apikey" type="password" placeholder="Zadej API kl√≠ƒç‚Ä¶">
        <button id="saveKey" class="btn ghost">Ulo≈æit</button>
      </div>

      <div id="whoRow" class="row hidden">
        <label style="min-width:70px">U≈æivatel</label>
        <span id="who">‚úì kl√≠ƒç ulo≈æen</span>
        <button id="logout" class="btn ghost">Odhl√°sit</button>
      </div>

      <div class="sep"></div>

      <label>Model</label>
      <select id="model">
        <option value="auto" selected>Automatick√Ω v√Ωbƒõr</option>
        <!-- dynamicky dopln√≠me z /v1/models -->
      </select>
      <div class="tip">‚Äûuncensored‚Äú modely jsou <b style="color:var(--danger)">ƒçerven√©</b> a nevyb√≠raj√≠ se v re≈æimu ‚ÄûAutomaticky‚Äú.</div>

      <div class="sep"></div>

      <label>Pamƒõ≈•</label>
      <div class="row">
        <label><input type="radio" name="memory" value="public" checked> Ve≈ôejn√°</label>
        <label><input type="radio" name="memory" value="private"> Soukrom√°</label>
      </div>

      <div class="sep"></div>

      <label><input type="checkbox" id="websearch"> Povolit websearch</label>

      <div class="sep"></div>

      <label>P≈ôilo≈æit TXT k dotazu</label>
      <input id="file" type="file" accept=".txt,text/plain">

      <div class="sep"></div>

      <div class="row">
        <button id="newChat" class="btn ghost">Nov√Ω chat</button>
        <span class="small" id="ttlInfo" title="Historie se dr≈æ√≠ 7 dn√≠">‚è≥ 7 dn√≠</span>
      </div>
    </section>

    <!-- chat -->
    <section class="col panel" aria-label="Chat">
      <div id="chat">
        <div id="messages" aria-live="polite"></div>

        <div>
          <label>Dotaz</label>
          <textarea id="prompt" placeholder="Zadej dotaz‚Ä¶ (Enter = odeslat, Shift+Enter = nov√Ω ≈ô√°dek)"></textarea>
          <div class="row" style="margin-top:.4rem">
            <button id="send" class="btn">Odeslat</button>
            <a id="download" class="btn ghost hidden" download="odpoved.txt">St√°hnout odpovƒõƒè (.txt)</a>
          </div>
        </div>
      </div>
    </section>

    <!-- prav√Ω panel -->
    <aside class="col" aria-label="N√°stroje">
      <details open>
        <summary>üìñ Kontext</summary>
        <pre id="context" class="block small">(zat√≠m pr√°zdn√©)</pre>
      </details>
      <div style="height:8px"></div>
      <details>
        <summary>üß™ Debug</summary>
        <pre id="debug" class="block small">(≈æ√°dn√Ω)</pre>
      </details>
      <div style="height:8px"></div>
      <details open>
        <summary>üß¨ Model</summary>
        <pre id="modelMeta" class="block small">(nen√≠ vybr√°no)</pre>
      </details>
    </aside>
  </main>

  <script>
    // ---- helpers & state ----
    const $ = s => document.querySelector(s);
    const logo = $('#logo');
    const apikeyInput = $('#apikey');
    const apikeyRow   = $('#apikeyRow');
    const saveKeyBtn  = $('#saveKey');
    const whoRow      = $('#whoRow');
    const whoSpan     = $('#who');
    const logoutBtn   = $('#logout');
    const modelSel    = $('#model');
    const modelMetaPre= $('#modelMeta');
    const memoryRadios= () => document.querySelector('input[name="memory"]:checked')?.value || 'public';
    const websearchCb = $('#websearch');
    const fileInput   = $('#file');
    const newChatBtn  = $('#newChat');
    const promptEl    = $('#prompt');
    const sendBtn     = $('#send');
    const downloadA   = $('#download');
    const messagesBox = $('#messages');
    const ctxPre      = $('#context');
    const dbgPre      = $('#debug');

    const LS_KEY = 'fura_ui';
    const TTL_MS = 7 * 24 * 60 * 60 * 1000;

    let state = loadState();
    let modelsMap = Object.create(null); // id -> raw model object

    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return { created: Date.now(), apikey: '', history: [] };
        const obj = JSON.parse(raw);
        if (!obj.created || (Date.now() - obj.created) > TTL_MS) {
          return { created: Date.now(), apikey: '', history: [] };
        }
        return obj;
      } catch { return { created: Date.now(), apikey: '', history: [] }; }
    }
    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function setBusy(b) { logo.classList.toggle('spin', !!b); sendBtn.disabled = !!b; }

    function authHeaders() {
      const h = {};
      if (state.apikey) h['X-API-Key'] = state.apikey;
      return h;
    }

    function isUncensored(id) {
      return /(uncensored|unfiltered|no[-_]?guard|nolimit|dolphin[-_]?uncensored)/i.test(id);
    }

    function preferAutoModel(list) {
      const prefer = ['llama3.1:8b', 'llama3:8b', 'qwen2.5:7b', 'mistral:7b', 'phi3'];
      for (const p of prefer) {
        const hit = list.find(m => !m.unc && m.id.toLowerCase().includes(p));
        if (hit) return hit.id;
      }
      const firstSafe = list.find(m => !m.unc);
      return firstSafe ? firstSafe.id : (list[0]?.id || 'llama3:8b');
    }

    function addMessage(role, text) {
      const div = document.createElement('div');
      const label = role === 'user' ? 'Ty' : (role === 'ai' ? 'Jarvik' : 'Syst√©m');
      div.className = 'msg ' + (role === 'user' ? 'user' : role === 'ai' ? 'ai' : 'system');
      div.setAttribute('data-role', label);
      div.textContent = text;
      messagesBox.appendChild(div);
      // rolovat dol≈Ø
      messagesBox.scrollTop = messagesBox.scrollHeight;
    }

    function applyApikeyUI() {
      if (state.apikey) {
        apikeyRow.classList.add('hidden');
        whoRow.classList.remove('hidden');
        whoSpan.textContent = '‚úì kl√≠ƒç ulo≈æen';
      } else {
        whoRow.classList.add('hidden');
        apikeyRow.classList.remove('hidden');
      }
    }

    function renderModelMeta(id) {
      if (!id || id === 'auto') {
        modelMetaPre.textContent = '(automatick√Ω v√Ωbƒõr ‚Äì konkr√©tn√≠ model se uk√°≈æe po odpovƒõdi)';
        return;
      }
      const m = modelsMap[id];
      if (!m) {
        modelMetaPre.textContent = `id: ${id}\n(detaily zat√≠m nezn√°m)`;
        return;
      }
      // Zkus√≠me z typick√Ωch kl√≠ƒç≈Ø vytƒõ≈æit metadata; fallback: JSON
      const lines = [];
      const push = (k, v) => { if (v !== undefined && v !== null && v !== '') lines.push(`${k}: ${v}`); };
      push('id', m.id || m.name);
      push('family', m.family || m.base_model || m.architecture);
      push('size', m.size || m.parameters || m.params);
      push('context', m.context_length || m.ctxlen || m.ctx || m.max_context);
      push('quant', m.quantization || m.quant || m.dtype);
      push('variant', m.variant || m.format);
      if (!lines.length) {
        modelMetaPre.textContent = JSON.stringify(m, null, 2);
      } else {
        modelMetaPre.textContent = lines.join('\n');
      }
    }

    // ---- dynamick√© naƒçten√≠ model≈Ø ----
    async function loadModels() {
      try {
        const resp = await fetch('/v1/models', { headers: authHeaders() });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const arr = Array.isArray(data?.data) ? data.data : Array.isArray(data) ? data : [];
        if (!arr.length) throw new Error('empty models');

        // mapa id -> raw
        modelsMap = Object.create(null);
        for (const m of arr) {
          const id = m.id || m.name;
          if (id) modelsMap[id] = m;
        }

        // vyƒçistit a znovu naplnit select
        const keepAuto = modelSel.querySelector('option[value="auto"]');
        modelSel.innerHTML = '';
        if (keepAuto) modelSel.appendChild(keepAuto);

        // rozt≈ô√≠dƒõn√≠
        const safe = [];
        const unc  = [];
        for (const m of arr) {
          const id = m.id || m.name || '';
          if (!id) continue;
          const entry = { id, unc: isUncensored(id) };
          (entry.unc ? unc : safe).push(entry);
        }
        safe.sort((a,b)=>a.id.localeCompare(b.id));
        unc.sort((a,b)=>a.id.localeCompare(b.id));

        const add = (group, list, cls) => {
          if (!list.length) return;
          const og = document.createElement('optgroup');
          og.label = group;
          for (const m of list) {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.id;
            if (cls) opt.className = cls;
            og.appendChild(opt);
          }
          modelSel.appendChild(og);
        };
        add('Doporuƒçen√© / bezpeƒçn√©', safe, '');
        add('Uncensored ‚ö†Ô∏è (nepou≈æije se v ‚ÄûAutomaticky‚Äú)', unc, 'uncensored');

        // po naƒçten√≠ rovnou vykresli meta pro aktu√°ln√≠ volbu (bude to "auto")
        renderModelMeta(modelSel.value);
      } catch (e) {
        console.warn('loadModels fallback:', e);
        ['llama3:8b','mistral','qwen2.5:7b'].forEach(id=>{
          const opt = document.createElement('option');
          opt.value = id; opt.textContent = id;
          modelSel.appendChild(opt);
        });
        renderModelMeta(modelSel.value);
      }
    }

    // ---- odesl√°n√≠ dotazu ----
    async function send() {
      const txt = (promptEl.value || '').trim();
      if (!txt) return;

      // p≈ôilo≈æen√Ω soubor
      let fileText = '';
      if (fileInput.files && fileInput.files[0]) {
        try {
          fileText = await fileInput.files[0].text();
        } catch { fileText = ''; }
      }
      let message = txt;
      if (fileText) {
        message += `\n\n[Attached file]\n${fileText}`;
      }

      // v√Ωbƒõr modelu
      let chosen = modelSel.value || 'auto';
      if (chosen === 'auto') {
        const allOpts = [...modelSel.querySelectorAll('option')].filter(o=>o.value && o.value !== 'auto');
        const arr = allOpts.map(o=>({ id: o.value, unc: o.classList.contains('uncensored') }));
        chosen = preferAutoModel(arr);
      }

      addMessage('user', txt);
      promptEl.value = '';
      setBusy(true); dbgPre.textContent = '(odes√≠l√°m‚Ä¶)';
      downloadA.classList.add('hidden'); downloadA.removeAttribute('href');

      const body = {
        model: chosen,
        message,
        websearch: !!websearchCb.checked,
        memory: memoryRadios()
      };

      try {
        const resp = await fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body)
        });
        const raw = await resp.text();
        dbgPre.textContent = `HTTP ${resp.status}\n` + raw;
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = JSON.parse(raw);
        const answer = data.response || data.answer || '';
        addMessage('ai', answer);

        // download link
        const blob = new Blob([answer], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        downloadA.href = url;
        downloadA.classList.remove('hidden');

        // kontext + metadata
        ctxPre.textContent = `model: ${chosen}\nwebsearch: ${!!websearchCb.checked}\nmemory: ${memoryRadios()}`;
        renderModelMeta(chosen);
      } catch (e) {
        addMessage('system', 'Chyba: ' + (e?.message || e));
      } finally {
        setBusy(false);
      }
    }

    // ---- init ----
    (function init(){
      applyApikeyUI();
      if (state.apikey) apikeyInput.value = state.apikey;
      loadModels();

      saveKeyBtn.onclick = () => {
        state.apikey = apikeyInput.value.trim();
        saveState();
        applyApikeyUI();
      };
      logoutBtn.onclick = () => {
        state.apikey = '';
        saveState();
        applyApikeyUI();
      };
      newChatBtn.onclick = () => {
        state = { created: Date.now(), apikey: state.apikey, history: [] };
        saveState();
        messagesBox.innerHTML = '';
        ctxPre.textContent = '(zat√≠m pr√°zdn√©)';
        dbgPre.textContent = '(≈æ√°dn√Ω)';
        downloadA.classList.add('hidden'); downloadA.removeAttribute('href');
      };

      sendBtn.onclick = send;
      promptEl.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
      });

      modelSel.addEventListener('change', () => renderModelMeta(modelSel.value));
    })();
  </script>
</body>
</html>
