 <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Otec Fura</title>
  <style>
    :root{
      --bg:#000000; --panel:#000000; --accent:#00ff00; --accent2:#00ff00; --text:#00ff00; --border:#00ff00; --muted:#00ff00;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-monospace,Menlo,Consolas,monospace}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:5}
    header img.logo{height:42px;filter:drop-shadow(0 0 6px rgba(0,255,136,.25))}
    header h1{margin:0;font-size:20px;color:var(--accent)}
    .wrap{display:grid;grid-template-columns:1fr 340px;gap:16px;padding:16px}
    @media(max-width:1100px){.wrap{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
    .controls{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px}
    @media(max-width:900px){.controls{grid-template-columns:1fr 1fr}}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],select,textarea{width:100%;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    textarea{min-height:96px;resize:vertical}
    .btn{background:var(--bg);color:var(--text);border:1px solid var(--border);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.secondary{background:var(--bg);border-color:var(--border);color:var(--text)}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;align-items:center;justify-content:center;z-index:10}
    .modal{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 0 0 1px rgba(0,255,136,.05),0 8px 24px rgba(0,0,0,.25);width:320px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--bg);border:1px solid var(--border);color:var(--text);border-radius:999px;padding:4px 10px;font-size:12px}
    #chat{height:480px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:6px}
    .bubble{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--bg)}
    .q{border-left:3px solid var(--border)}.a{border-left:3px solid var(--border)}
    .meta{font-size:11px;color:var(--muted);display:flex;gap:8px;margin-bottom:6px}
    .role{font-weight:700;color:var(--accent)}
    pre{white-space:pre-wrap;word-wrap:break-word}
    details{border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:var(--bg)}
    details summary{cursor:pointer;color:var(--accent)}
    .progress{height:3px;background:var(--bg);border-radius:99px;overflow:hidden;margin-top:10px;display:none}
    .progress .bar{height:100%;width:20%;background:var(--text);animation:load 1s infinite linear}
    @keyframes load{from{transform:translateX(-100%)}to{transform:translateX(500%)}}
  </style>
</head>
<body>
  <header>
    <img src="/static/alternative.png" alt="Otec Fura" class="logo"/>
    <h1>Otec Fura</h1>
    <button id="logoutBtn" class="btn secondary" style="margin-left:auto;display:none">Odhl√°sit</button>
  </header>

  <div id="tokenModal" class="modal-overlay" style="display:none">
    <div class="modal">
      <label class="small">Vlo≈æ sv≈Øj token</label>
      <input id="tokenModalInput" type="text" placeholder="Vlo≈æ sv≈Øj token‚Ä¶"/>
      <button class="btn" id="saveTokenModalBtn">Ulo≈æit token</button>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT: Chat -->
    <div class="leftcol">
      <div class="card">
        <div class="controls">
          <div>
            <label class="small"><input type="checkbox" id="autoModel" checked style="margin-right:6px"/>Automatick√Ω v√Ωbƒõr modelu</label>
            <select id="model" disabled>
              <option value="auto" selected>Automaticky (podle tokenu / backendu)</option>
            </select>
            <div id="modelHelp" class="hint" style="font-size:12px;color:var(--muted);margin-top:6px">Automatick√° volba modelu dle tokenu / pravidel backendu.</div>
          </div>
          <div>
            <label class="small">Pamƒõ≈•</label>
            <select id="memory">
              <option value="public">Ve≈ôejn√° (ƒçten√≠+z√°pis: ve≈ôejn√°)</option>
              <option value="private">Soukrom√° (ƒçten√≠: ve≈ôejn√°+priv√°tn√≠, z√°pis: priv√°tn√≠)</option>
            </select>
          </div>
        </div>
        <div class="controls" style="margin-top:12px;grid-template-columns:1fr 1fr 1fr 1fr">
          <div style="grid-column: span 2">
            <label class="small">Dotaz</label>
            <textarea id="message" placeholder="Zadej dotaz‚Ä¶ (Enter = nov√Ω ≈ô√°dek, Ctrl+Enter = odeslat)"></textarea>
          </div>
          <div>
            <label class="small">Soubor pro /crawl</label>
            <input id="fileInput" type="file" />
          </div>
          <div style="display:flex;gap:8px;align-items:end">
            <button class="btn" id="sendBtn">Odeslat</button>
            <button class="btn secondary" id="clearBtn">Vyƒçistit chat</button>
          </div>
        </div>
        <div class="row">
          <span class="pill" id="statusPill">P≈ôipraveno</span>
        </div>
        <div class="progress" id="progress"><div class="bar"></div></div>
      </div>

      <div class="card" style="margin-top:16px">
        <div id="chat" aria-live="polite"></div>
      </div>
    </div>

    <!-- RIGHT: Context / Debug -->
    <div class="rightcol">
      <div class="card">
        <div style="font-size:11px;color:var(--muted)">üìö Kontext (v√Ωchoz√≠ skryt√Ω)</div>
        <details>
          <summary>Zobrazit kontext</summary>
          <pre id="contextBox">(≈æ√°dn√Ω)</pre>
        </details>
      </div>
      <div class="card">
        <div style="font-size:11px;color:var(--muted)">üõ†Ô∏è Debug (v√Ωchoz√≠ skryt√Ω)</div>
        <details>
          <summary>Zobrazit debug</summary>
          <pre id="debugBox">{}</pre>
          <button class="btn secondary" id="showFullBtn" style="display:none;margin-top:8px">Zobrazit cel√©</button>
        </details>
      </div>
    </div>
  </div>

  <script>
    function runSanityTests(){
      const required = ["model","modelHelp","memory","chat","message","sendBtn","clearBtn"];
      const missing = required.filter(id => !document.getElementById(id));
      const dbg = document.getElementById('debugBox');
      if (missing.length){
        const msg = `[SELF-TEST] Chyb√≠ elementy: ${missing.join(', ')}`;
        console.error(msg);
        if (dbg) dbg.textContent = msg;
      } else {
        const ok = '[SELF-TEST] OK ‚Äì v≈°echny povinn√© elementy existuj√≠.';
        console.log(ok);
        if (dbg) dbg.textContent = ok;
      }
    }

    async function loadModels() {
      const select = document.getElementById("model");
      if (!select){ console.error('Select #model nebyl nalezen.'); return; }
      try {
        const res = await fetch("/static/models_meta.json");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const meta = await res.json().catch(()=>null);
        if (!meta || typeof meta !== 'object') throw new Error("Neplatn√° data models_meta.json");
        const entries = Object.entries(meta);
        if (!entries.length) throw new Error("Pr√°zdn√° odpovƒõƒè models_meta.json");
        entries.sort((a,b)=> (a[1].label||a[0]).localeCompare(b[1].label||b[0]));
        for (const [id, info] of entries) {
          const opt = document.createElement("option");
          const label = info.label || id;
          opt.value = id;
          opt.textContent = label;
          const extra = [info.group, info.tier].filter(Boolean).join(", ");
          if (extra) opt.textContent += ` ‚Äî ${extra}`;
          if (info.tip || info.description) opt.title = info.tip || info.description;
          const diff = translateDifficulty(info.difficulty);
          opt.dataset.label = label;
          opt.dataset.tip = info.tip || info.description || "";
          opt.dataset.description = info.description || "";
          opt.dataset.group = info.group || "";
          opt.dataset.tier = info.tier || "";
          opt.dataset.difficulty = diff;
          opt.dataset.type = info.type || "general";
          select.appendChild(opt);
        }
      } catch (e) {
        console.warn("Naƒçten√≠ models_meta.json selhalo:", e);
        // tich√Ω fallback ‚Äì UI z≈Østane s volbou ‚Äûauto‚Äú
      }
      updateModelHelp();
    }

    function translateDifficulty(level){
      switch(level){
        case "low": return "n√≠zk√°";
        case "medium": return "st≈ôedn√≠";
        case "high": return "vysok√°";
        default: return level || "neuvedeno";
      }
    }

    function updateModelHelp(){
      const sel = document.getElementById('model');
      const help = document.getElementById('modelHelp');
      if (!sel || !help) return;
      if (sel.value === 'auto'){
        help.textContent = 'Automatick√° volba modelu dle tokenu / pravidel backendu.';
      } else {
        const opt = sel.options[sel.selectedIndex];
        const label = opt?.dataset?.label || sel.value;
        const tip = opt?.dataset?.tip || opt?.dataset?.description || '';
        const tipPart = tip ? ` ‚Äî ${tip}` : '';
        const group = opt?.dataset?.group ? `, skupina: ${opt.dataset.group}` : '';
        const tier = opt?.dataset?.tier ? `, tier: ${opt.dataset.tier}` : '';
        const diff = opt?.dataset?.difficulty ? `, t√≠ha: ${opt.dataset.difficulty}` : '';
        help.textContent = `${label}${tipPart}${group}${tier}${diff}`;
      }
    }

                const chat = document.getElementById('chat');
      const sendBtn = document.getElementById('sendBtn');
      const clearBtn = document.getElementById('clearBtn');
      const messageEl = document.getElementById('message');
      const progress = document.getElementById('progress');
      const statusPill = document.getElementById('statusPill');
      const tokenModal = document.getElementById('tokenModal');
      const tokenInputEl = document.getElementById('tokenModalInput');
      const showFullBtn = document.getElementById('showFullBtn');
      const saveTokenModalBtn = document.getElementById('saveTokenModalBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const autoModelChk = document.getElementById('autoModel');

      function getToken(){
        return localStorage.getItem('api_key') || '';
      }

      function updateTokenUI(){
        const saved = getToken();
        if (saved){
          tokenModal.style.display='none';
          logoutBtn.style.display='inline-block';
          tokenInputEl.value='';
        } else {
          tokenModal.style.display='flex';
          logoutBtn.style.display='none';
        }
      }

      function saveHistory(role, text, time){
        const maxAge = 7*24*60*60*1000;
        const now = Date.now();
        let hist = [];
        try{ hist = JSON.parse(localStorage.getItem('chat_history')||'[]'); }catch{}
        hist.push({role,text,time});
        hist = hist.filter(item => now - item.time <= maxAge);
        localStorage.setItem('chat_history', JSON.stringify(hist));
      }

      function loadHistory(){
        const maxAge = 7*24*60*60*1000;
        const now = Date.now();
        let hist = [];
        try{ hist = JSON.parse(localStorage.getItem('chat_history')||'[]'); }catch{}
        hist = hist.filter(item => now - item.time <= maxAge);
        localStorage.setItem('chat_history', JSON.stringify(hist));
        hist.forEach(item => addBubble(item.role, item.text, false, item.time));
      }

      function addBubble(role, text, save=true, timestamp=Date.now()){
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role==='user'?'q':'a'}`;
        const timeStr = new Date(timestamp).toLocaleTimeString();
        bubble.innerHTML = `<div class="meta"><span class="role">${role==='user'?'‚ùì Ot√°zka':'‚úÖ Odpovƒõƒè'}</span><span>üïê ${timeStr}</span></div><pre></pre>`;
        bubble.querySelector('pre').textContent = text;
        chat.appendChild(bubble);
        chat.scrollTop = chat.scrollHeight;
        if (save) saveHistory(role, text, timestamp);
      }

      async function sendMessage(){
        const tokenInput = tokenInputEl.value.trim();
        const token = tokenInput || getToken();
        const model = document.getElementById('model').value;
        const memory = document.getElementById('memory').value;
        const file = document.getElementById('fileInput').files[0];
        const msg = messageEl.value.trim();
        if (!msg && !file) return;

        const headers = {'Accept':'application/json, text/plain;q=0.5, */*;q=0.1'};
        if (token) headers['Authorization'] = `Bearer ${token}`;

        let fetchInit;
        let requestPayload = { message: msg, memory_mode: memory };
        if (model !== 'auto') requestPayload.model = model;

        if (file){
          const fd = new FormData();
          fd.append('file', file);
          const crawlHeaders = {};
          if (token) crawlHeaders['Authorization'] = `Bearer ${token}`;
          await fetch('/crawl', { method:'POST', headers: crawlHeaders, body: fd });
        }

        headers['Content-Type'] = 'application/json';
        fetchInit = { method:'POST', headers, body: JSON.stringify(requestPayload) };

        addBubble('user', msg || `(soubor: ${file?.name})`);
        messageEl.value = '';
        statusPill.textContent = 'Odes√≠l√°m‚Ä¶';
        progress.style.display = 'block';
        sendBtn.disabled = true;

        const endpoint = '/ask';
        try{
          const res = await fetch(endpoint, fetchInit);
          const ct = res.headers.get('content-type') || '';
          let data; let rawText = '';
          if (ct.includes('application/json')){
            try {
              data = await res.json();
            } catch(e){
              rawText = (await res.text()) || '';
            }
          } else {
            rawText = (await res.text()) || '';
          }

          let answerText = '';
          let ctx = null;

          if (!res.ok){
            const errMsg = (data && (data.detail || data.error)) || rawText.trim() || res.statusText;
            answerText = `Chyba: [${res.status}] ${errMsg}`;
          } else if (data){
            if (data.answer){
              answerText = data.answer;
            } else if (Array.isArray(data.memory) || Array.isArray(data.knowledge)){
              const parts = [];
              if (Array.isArray(data.memory)) parts.push(data.memory.join('\n'));
              if (Array.isArray(data.knowledge)) parts.push(data.knowledge.join('\n'));
              answerText = parts.join('\n') || '[pr√°zdn√° odpovƒõƒè]';
            } else {
              answerText = data.detail || '[pr√°zdn√° odpovƒõƒè]';
            }
            ctx = data.context || { memory: data.memory, knowledge: data.knowledge };
          } else {
            answerText = rawText.trim() || `[${res.status}] Odpovƒõƒè bez JSON (Content-Type: ${ct || 'n/a'})`;
          }

          addBubble('assistant', answerText);
          document.getElementById('contextBox').textContent = ctx ? JSON.stringify(ctx, null, 2) : '(≈æ√°dn√Ω)';
          const debugBox = document.getElementById('debugBox');
          const debugData = {
            endpoint,
            request: requestPayload,
            status: res.status,
            contentType: ct,
            json: !!data,
            bodyPreview: data ? JSON.stringify(data).slice(0,200) : rawText.slice(0,200)
          };
          debugBox.textContent = JSON.stringify(debugData, null, 2);
          if ((data && JSON.stringify(data).length > 200) || (!data && rawText.length > 200)) {
            showFullBtn.style.display = 'inline-block';
            showFullBtn.onclick = () => {
              debugBox.textContent = JSON.stringify({
                ...debugData,
                body: data || rawText
              }, null, 2);
              showFullBtn.style.display = 'none';
            };
          } else {
            showFullBtn.style.display = 'none';
            showFullBtn.onclick = null;
          }
        }catch(err){
          addBubble('assistant', `Chyba: ${err?.message || err}`);
        }finally{
          progress.style.display = 'none';
          sendBtn.disabled = false;
          statusPill.textContent = 'P≈ôipraveno';
        }
      }

      messageEl.addEventListener('keydown', (e)=>{ if (e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); sendMessage(); }});
      sendBtn.addEventListener('click', sendMessage);
      clearBtn.addEventListener('click', ()=>{ chat.innerHTML=''; localStorage.removeItem('chat_history'); });
      document.getElementById('model').addEventListener('change', updateModelHelp);
      autoModelChk.addEventListener('change', ()=>{
        const sel = document.getElementById('model');
        if (autoModelChk.checked){ sel.value='auto'; sel.disabled=true; }
        else{ sel.disabled=false; }
        updateModelHelp();
      });
      saveTokenModalBtn.addEventListener('click', ()=>{
        const val = tokenInputEl.value.trim();
        if (val){
          localStorage.setItem('api_key', val);
          updateTokenUI();
        }
      });
      logoutBtn.addEventListener('click', ()=>{
        localStorage.removeItem('api_key');
        updateTokenUI();
      });

      document.addEventListener('DOMContentLoaded', ()=>{
        runSanityTests();
        updateTokenUI();
        loadModels();
        loadHistory();
        const sel = document.getElementById('model');
        if (autoModelChk.checked){ sel.disabled = true; sel.value='auto'; }
        updateModelHelp();
      });
  </script>
</body>
</html>
